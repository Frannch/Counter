<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fran's Race</title>
    <style>
      html, body { height: 100%; }
      body {
        margin: 0;
        background: #000;
        display: flex;               /* centrar */
        align-items: center;         /* vertical */
        justify-content: center;     /* horizontal */
      }
      #gameCanvas {
        width: 1024px;   /* antes 512px */
        height: 768px;   /* antes 384px */
        display: block;
      }
    </style>
  </head>
  <body>
      <canvas id="gameCanvas" width="1024" height="768"></canvas>

      <script src="main.min.js"></script>

      <script>
      (function () {
        const GAME_ID = 'racer';                // id que tengas en js/lobby.js
        const LOBBY_PATH = '../html/lobby.html';
        const REDIRECT_DELAY = 10;              // segundos
        const WATCH_MS = 200;

        function notifyWinAndRedirect(gameId, lobbyPath, seconds = 10) {
          try { localStorage.setItem(`win_${gameId}`, '1'); } catch (_) {}
          const target = `${lobbyPath}?win=${encodeURIComponent(gameId)}`;

          if (!document.getElementById('win-overlay-style')) {
            const style = document.createElement('style');
            style.id = 'win-overlay-style';
            style.textContent = `
              .win-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:99999}
              .win-box{background:#111;color:#fff;max-width:560px;width:90%;padding:24px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.4);text-align:center;font-family:system-ui,Segoe UI,Roboto,Arial}
              .win-box h2{margin:0 0 8px;font-size:1.8rem}
              .win-box p{margin:6px 0}
              .win-actions{margin-top:14px;display:flex;gap:8px;justify-content:center}
              .win-btn{padding:.6rem 1rem;border-radius:8px;border:0;cursor:pointer;font-weight:700}
              .win-btn.primary{background:#22c55e;color:#111}
              .win-count{font-weight:800}
            `;
            document.head.appendChild(style);
          }

          const overlay = document.createElement('div');
          overlay.className = 'win-overlay';
          overlay.innerHTML = `
            <div class="win-box" role="dialog" aria-modal="true" aria-label="Has ganado">
              <h2>¡Felicitaciones!</h2>
              <p>Has quedado entre los 3 primeros.</p>
              <p>Volviendo al lobby en <span class="win-count" id="win-count">${seconds}</span> segundos…</p>
              <div class="win-actions">
                <button class="win-btn primary" id="win-go-now">Ir ahora</button>
              </div>
            </div>
          `;
          document.body.appendChild(overlay);

          // Bloquear entradas del juego mientras está el overlay
          function stopKeys(e){ e.stopImmediatePropagation(); }
          window.addEventListener('keydown', stopKeys, true);
          window.addEventListener('keyup', stopKeys, true);

          const countEl = overlay.querySelector('#win-count');
          const goNow = overlay.querySelector('#win-go-now');
          function go(){ window.location.href = target; }
          let left = seconds;
          const t = setInterval(() => {
            left -= 1;
            if (left <= 0) { clearInterval(t); go(); }
            else { countEl.textContent = String(left); }
          }, 1000);
          goNow.addEventListener('click', () => { clearInterval(t); go(); });
        }

        // Lee el puesto final: cars[0].g5 -> "1st", "2nd", ...
        function getFinalRank() {
          try {
            const s = (window.cars && window.cars[0] && window.cars[0].g5) || '';
            const m = String(s).match(/^\d+/);
            return m ? parseInt(m[0], 10) : NaN;
          } catch { return NaN; }
        }

        let shown = false;
        function watchFinish() {
          const r = window.race;
          if (!r || shown) return;
          if (r.state === 5) { // STATE_RACEOVER
            const rank = getFinalRank();
            if (Number.isFinite(rank) && rank >= 1 && rank <= 3) {
              shown = true;
              notifyWinAndRedirect(GAME_ID, LOBBY_PATH, REDIRECT_DELAY);
            }
          }
        }

        window.addEventListener('load', () => {
          setInterval(watchFinish, WATCH_MS);
        });
      })();
      </script>
  </body>
</html>